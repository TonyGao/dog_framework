{% extends 'admin/layout.html.twig' %}
{% import 'components/datagrid.html.twig' as grid %}
{% import 'ui/template/ui.html.twig' as ui %}

{% block title %}岗位管理
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		// 岗位管理drawer功能
		function openPositionViewDrawer(positionId) {
			// 防止重复点击，先移除已存在的drawer
			$('#position-drawer-' + positionId).remove();
			// 移除所有其他打开的drawer
			$('[id^="position-drawer-"]').remove();
			
			ajax({
				method: 'POST',
				url: '/admin/org/position/drawer',
				data: {
					positionId: positionId,
					action: 'view'
				},
				contentType: 'application/json',
				dataType: 'html',
				success: function(html) {
					// 添加新的drawer到页面
					$('body').append(html);
					
					// 显示drawer
					$().showDrawer('position-drawer-' + positionId);
				},
				error: function(xhr, status, error) {
					console.error('Error loading position drawer:', error);
					alert('加载岗位详情失败，请重试');
				}
			});
		}
		
		function openPositionEditDrawer(positionId) {
			// 防止重复点击，先移除已存在的drawer
			$('#position-drawer-' + positionId).remove();
			// 移除所有其他打开的drawer
			$('[id^="position-drawer-"]').remove();
			
			ajax({
				method: 'POST',
				url: '/admin/org/position/drawer',
				data: {
					positionId: positionId,
					action: 'edit'
				},
				contentType: 'application/json',
				dataType: 'html',
				success: function(html) {
					// 添加新的drawer到页面
					$('body').append(html);
					
					// 显示drawer
					$().showDrawer('position-drawer-' + positionId);
				},
				error: function(xhr, status, error) {
					console.error('Error loading position edit drawer:', error);
					alert('加载岗位编辑失败，请重试');
				}
			});
		}
		
		function openPositionCreateDrawer() {
			// 移除所有其他打开的drawer
			$('[id^="position-drawer-"]').remove();
			
			ajax({
				method: 'POST',
				url: '/admin/org/position/drawer',
				data: {
					action: 'create'
				},
				contentType: 'application/json',
				dataType: 'html',
				success: function(html) {
					// 添加新的drawer到页面
					$('body').append(html);
					
					// 显示drawer
					$().showDrawer('position-drawer-new');
				},
				error: function(xhr, status, error) {
					console.error('Error loading position create drawer:', error);
					alert('加载新增岗位失败，请重试');
				}
			});
		}
		
		// 为新增岗位按钮绑定点击事件
		$(document).ready(function() {
			$('#add-position-button').on('click', function() {
				openPositionCreateDrawer();
			});
		});
	</script>
{% endblock %}

{% block app_content_container %}
	<div class="org-structure-container">
		<div class="outside-wrapper" style="padding: 20px;">
			{{ grid.dataGrid(
                    tableData|default([]),
                    columns|default([]),
                    {
                        createUrl: path('org_position_new'),
                        editUrlPrefix: path('org_position_edit', {'id': 'placeholder'})|replace({'placeholder': ''}),
                        viewUrlPrefix: path('org_position_view', {'id': 'placeholder'})|replace({'placeholder': ''}),
                        deleteUrlPrefix: path('org_position_delete', {'id': 'placeholder'})|replace({'placeholder': ''}),
                        batchDeleteUrl: path('api_org_position_batch_delete'),
                        toolbarButtons: [
                            { type: 'create', text: '新增岗位', icon: 'fa-solid fa-plus-circle', id: 'add-position-button' },
                            { type: 'delete', text: '批量删除', icon: 'fa-solid fa-minus-circle', id: 'batch-delete-button' },
                            { type: 'filter', text: '高级搜索', icon: 'fa-solid fa-filter', id: 'filter-button', classes: 'search' }
                        ],
                        actionButtons: [
                            { type: 'view', text: '查看', icon: 'fa-solid fa-eye' },
                            { type: 'edit', text: '编辑', icon: 'fa-solid fa-edit' },
                            { type: 'delete', text: '删除', icon: 'fa-solid fa-trash' }
                        ],
                        emptyText: '暂无岗位数据',
                        sortable: true,
                        maxWidth: '100%',
                        minHeight: '500px',
                        autoFitContent: false,
                        gridId: 'position-grid',
                        pagination: true,
                        serverSide: true,
                        dataUrl: path('api_org_position_list'),
                        pageSize: 20,
                        currentPage: 1,
                        totalPages: 1,
                        totalItems: 0,
                        showCheckbox: true,
                        showRowNumber: true
                    }
                ) }}
		</div>
	</div>
{% endblock %}
