{% extends 'admin/layout.html.twig' %}
{% import 'components/datagrid.html.twig' as grid %}
{% import 'ui/template/ui.html.twig' as ui %}

{% block title %}岗位管理
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		// 岗位管理drawer功能
		function openPositionViewDrawer(positionId) {
			fetch('/admin/org/position/drawer', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify({
					positionId: positionId,
					action: 'view'
				})
			})
			.then(response => response.text())
			.then(html => {
				// 移除已存在的drawer
				const existingDrawer = document.getElementById('position-drawer-' + positionId);
				if (existingDrawer) {
					existingDrawer.remove();
				}
				
				// 添加新的drawer到页面
				document.body.insertAdjacentHTML('beforeend', html);
				
				// 显示drawer
				$().showDrawer('position-drawer-' + positionId);
			})
			.catch(error => {
				console.error('Error loading position drawer:', error);
				alert('加载岗位详情失败，请重试');
			});
		}
		
		function openPositionEditDrawer(positionId) {
			fetch('/admin/org/position/drawer', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-Requested-With': 'XMLHttpRequest'
				},
				body: JSON.stringify({
					positionId: positionId,
					action: 'edit'
				})
			})
			.then(response => response.text())
			.then(html => {
				// 移除已存在的drawer
				const existingDrawer = document.getElementById('position-drawer-' + positionId);
				if (existingDrawer) {
					existingDrawer.remove();
				}
				
				// 添加新的drawer到页面
				document.body.insertAdjacentHTML('beforeend', html);
				
				// 显示drawer
				$().showDrawer('position-drawer-' + positionId);
			})
			.catch(error => {
				console.error('Error loading position edit drawer:', error);
				alert('加载岗位编辑失败，请重试');
			});
		}
		
		// 修改datagrid的查看和编辑按钮行为
		document.addEventListener('DOMContentLoaded', function() {
			// 重写查看按钮点击事件
			document.addEventListener('click', function(e) {
				if (e.target.closest('.ef-button-view')) {
					e.preventDefault();
					const button = e.target.closest('.ef-button-view');
					const row = button.closest('tr');
					const positionId = row.getAttribute('data-id');
					if (positionId) {
						openPositionViewDrawer(positionId);
					}
				}
				
				if (e.target.closest('.ef-button-edit')) {
					e.preventDefault();
					const button = e.target.closest('.ef-button-edit');
					const row = button.closest('tr');
					const positionId = row.getAttribute('data-id');
					if (positionId) {
						openPositionEditDrawer(positionId);
					}
				}
			});
		});
	</script>
{% endblock %}

{% block app_content_container %}
	<div class="org-structure-container">
		<div class="outside-wrapper" style="padding: 20px;">
			{{ grid.dataGrid(
                    tableData|default([]),
                    columns|default([]),
                    {
                        createUrl: path('org_position_new'),
                        editUrlPrefix: path('org_position_edit', {'id': 'placeholder'})|replace({'placeholder': ''}),
                        viewUrlPrefix: path('org_position_view', {'id': 'placeholder'})|replace({'placeholder': ''}),
                        deleteUrlPrefix: path('org_position_delete', {'id': 'placeholder'})|replace({'placeholder': ''}),
                        toolbarButtons: [
                            { type: 'create', text: '新增岗位', icon: 'fa-solid fa-plus-circle', id: 'add-position-button' },
                            { type: 'delete', text: '批量删除', icon: 'fa-solid fa-minus-circle', id: 'batch-delete-button' },
                            { type: 'filter', text: '高级搜索', icon: 'fa-solid fa-filter', id: 'filter-button', classes: 'search' }
                        ],
                        actionButtons: [
                            { type: 'view', text: '查看', icon: 'fa-solid fa-eye' },
                            { type: 'edit', text: '编辑', icon: 'fa-solid fa-edit' },
                            { type: 'delete', text: '删除', icon: 'fa-solid fa-trash' }
                        ],
                        emptyText: '暂无岗位数据',
                        sortable: true,
                        maxWidth: '100%',
                        minHeight: '500px',
                        autoFitContent: false,
                        gridId: 'position-grid',
                        pagination: true,
                        serverSide: true,
                        dataUrl: path('api_org_position_list'),
                        pageSize: 20,
                        currentPage: 1,
                        totalPages: 1,
                        totalItems: 0,
                        showCheckbox: true,
                        showRowNumber: true
                    }
                ) }}
		</div>
	</div>
{% endblock %}
